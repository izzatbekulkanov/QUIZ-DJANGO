{% extends 'dashboard/index.html' %}
{% load static %}
{% load custom_filters %}

{% block style %}
{% endblock style %}


{% block content %}
<main id="main-container" class="content py-4">
    <nav aria-label="breadcrumb" class="bg-light rounded shadow-sm mb-4 px-3 py-2 mt-5">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
                <a href="{% url 'dashboard' %}" class="text-decoration-none"><i class="fa fa-home me-1"></i> Bosh sahifa</a>
            </li>
            <li class="breadcrumb-item">
                <a href="javascript:history.back()" class="text-decoration-none">Topshiriqlar</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Test maʼlumotlari</li>
        </ol>
    </nav>

    <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white text-center">
            <h4 class="mb-0">Test maʼlumotlari</h4>
        </div>
        <div class="card-body p-4">
            <table class="table table-borderless">
                <tbody>
                    <tr>
                        <th class="text-muted">Test nomi</th>
                        <td>{{ assignment.test_name }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">Kategoriya</th>
                        <td>{{ assignment.category_name }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">O'qituvchi</th>
                        <td>{{ assignment.teacher_name }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">Savollar soni</th>
                        <td>{{ assignment.total_questions }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">Boshlanish vaqti</th>
                        <td>{{ assignment.start_time }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">Tugash vaqti</th>
                        <td>{{ assignment.end_time }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">Davomiylik</th>
                        <td>{{ assignment.duration }} daqiqa</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="card-footer bg-light text-center">
            <button class="btn btn-success btn-lg w-100 shadow" id="start-test-btn" data-assignment-id="{{ assignment.id }}">
                <i class="fa fa-play me-2"></i>Testni Boshlash
            </button>
        </div>
    </div>
</main>
{% endblock content %}



{% block script %}

  <script src="{% static 'assets/js/plugins/sweetalert2/sweetalert2.all.min.js' %}"></script>

  <script>
document.addEventListener('DOMContentLoaded', function () {
    const startButton = document.getElementById('start-test-btn');

    startButton.addEventListener('click', function () {
        const assignmentId = this.getAttribute('data-assignment-id');

        // LocalStorage-dan joriy test sahifasini o'chirish
        localStorage.removeItem('currentQuestionIndex');
        localStorage.removeItem('selectedAnswers');

        // Foydalanuvchi uchun tekshirish
        fetch(`/check-unfinished-test/${assignmentId}/`, { 
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then((response) => response.json())
            .then((data) => {
                if (data.unfinished) {
                    // Yakunlanmagan test mavjud bo‘lsa
                    Swal.fire({
                        title: 'Yakunlanmagan test mavjud!',
                        text: 'Siz oldingi testni yakunlamadingiz. Testni davom ettirishni xohlaysizmi?',
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonText: 'Ha, davom ettirish',
                        cancelButtonText: 'Bekor qilish',
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = `/start-test/${assignmentId}/`;
                        }
                    });
                } else {
                    // Yangi testni boshlash
                    Swal.fire({
                        title: 'Testni boshlashni xohlaysizmi?',
                        text: "Tasdiqlangandan so‘ng testni boshlash imkoniyati bo‘ladi.",
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Ha, boshlash',
                        cancelButtonText: 'Bekor qilish',
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Orqaga sanoqni boshlash
                            let countdown = 3;
                            const interval = setInterval(() => {
                                Swal.fire({
                                    title: `${countdown}`,
                                    html: 'Test boshlanmoqda...',
                                    timer: 1000,
                                    showConfirmButton: false,
                                    allowOutsideClick: false,
                                    allowEscapeKey: false,
                                    didOpen: () => {
                                        Swal.showLoading();
                                    },
                                });

                                countdown -= 1;

                                // Sanoq tugagandan keyin yo‘naltirish
                                if (countdown < 0) {
                                    clearInterval(interval);
                                    window.location.href = `/start-test/${assignmentId}/`;
                                }
                            }, 1000);
                        }
                    });
                }
            })
            .catch((error) => {
                Swal.fire('Xatolik', 'Server bilan bog‘lanishda muammo yuz berdi.', 'error');
                console.error(error);
            });
    });
});
  </script>

{% endblock script %}