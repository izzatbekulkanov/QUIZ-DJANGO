{% extends 'question/main.html' %}
{% load static %}
{% block style %}
  <link rel="stylesheet" href="{% static 'assets/js/plugins/dropzone/min/dropzone.min.css' %}">

{% endblock style %}
<style>
    .card {
        border-radius: 10px;
        overflow: hidden;
    }

    .card-title {
        font-weight: 600;
    }

    .card-text {
        font-size: 0.9rem;
    }
</style>
{% block content %}
  <main id="main-container">
    <!-- Hero -->
    <div class="bg-image overflow-hidden"
         style="background-image: url('{% static "assets/media/photos/photo3@2x.jpg" %}');">
      <div class="bg-primary-dark-op">
        <div class="content content-full">
          <div
            class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center mt-5 mb-2 text-center text-sm-start">
            <div class="flex-grow-1">
              <h1 class="fw-semibold text-white mb-0">Kategoriyalar</h1>

            </div>
            <div class="flex-shrink-0 mt-3 mt-sm-0 ms-sm-3">
                  <span class="d-inline-block">
                    <a class="btn btn-primary px-4 py-2" href="{% url 'add-category' %}">
                      <i class="fa fa-plus me-1 opacity-50"></i> Kategoriya qo'shish
                    </a>
                  </span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- END Hero -->


    <hr>
    <!-- Page Content -->
    <div class="content">
      <div class="row g-4">
        {% for category in categories %}
          <div class="col-sm-6 col-lg-4">
            <div class="card h-100 shadow-sm border-0">
              <!-- Category Image -->
              <img
                src="
                  {% if category.image %}{{ category.image.url }}{% else %}{% static 'assets/images/question_category.png' %}{% endif %}"
                class="card-img-top rounded-top"
                alt="{{ category.name }}"
                style="height: 180px; object-fit: cover;">

              <div class="card-body d-flex flex-column">
                <!-- Category Title -->
                <h5 class="card-title fw-semibold text-dark">{{ category.name }}</h5>
                <p class="card-text text-muted small mb-3">
                  {{ category.description|default:"Tavsif mavjud emas." }}
                </p>

                <!-- Testlar -->
                {% if category.tests.exists %}
                  <div class="mb-2">
                    <h6 class="text-primary">Testlar ro‘yxati:</h6>
                    <div class="accordion" id="accordion-{{ category.id }}">
                      {% for test in category.tests.all %}
                        <div class="accordion-item">
                          <h2 class="accordion-header" id="heading-{{ test.id }}">
                            <button class="accordion-button collapsed py-1 px-2 fs-sm" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#collapse-{{ test.id }}"
                                    aria-expanded="false">
                              {{ test.name }}
                            </button>
                          </h2>
                          <div id="collapse-{{ test.id }}" class="accordion-collapse collapse"
                               data-bs-parent="#accordion-{{ category.id }}">
                            <div class="accordion-body p-2">
                              {% if test.questions.count > 0 %}
                                <ul class="list-unstyled mb-0">
                                  {% for question in test.questions.all %}
                                    <li class="text-muted small">- {{ question.text|truncatewords:10 }}</li>
                                  {% endfor %}
                                </ul>
                              {% else %}
                                <p class="text-muted small mb-0">Savollar mavjud emas.</p>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                {% else %}
                  <p class="text-muted small">Testlar mavjud emas.</p>
                {% endif %}

                <!-- Buttons -->
                <div class="mt-auto d-flex justify-content-between pt-3">
                  <a href="{% url 'edit-category' category.id %}" class="btn btn-sm btn-outline-primary w-50 me-2">
                    <i class="fa fa-edit me-1"></i> Tahrirlash
                  </a>
                  <button class="btn btn-sm btn-outline-danger w-50" onclick="deleteCategory({{ category.id }})">
                    <i class="fa fa-trash me-1"></i> O‘chirish
                  </button>
                </div>
              </div>
            </div>
          </div>
        {% empty %}
          <div class="col-12">
            <div class="alert alert-info text-center mb-0">
              <i class="fa fa-info-circle me-2"></i> Hozircha hech qanday kategoriya mavjud emas.
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- END Page Content -->
  </main>
{% endblock content %}

{% block script %}
  <!-- jQuery (required for Select2 + Bootstrap Maxlength plugin) -->
  <script src="{% static 'assets/js/lib/jquery.min.js' %}"></script>
  <script src="{% static 'assets/js/plugins/sweetalert2/sweetalert2.all.min.js' %}"></script>

  <script>
    function getCSRFToken() {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
          return value;
        }
      }
      console.error('CSRF token is missing in cookies!');
      return null;
    }

    function deleteCategory(categoryId) {
      const csrfToken = getCSRFToken();

      if (!csrfToken) {
        Swal.fire({
          title: 'Xatolik!',
          text: 'CSRF token topilmadi!',
          icon: 'error',
          confirmButtonText: 'OK',
        });
        return;
      }

      Swal.fire({
        title: 'Tasdiqlaysizmi?',
        text: 'Ushbu kategoriyani o‘chirmoqchimisiz?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Ha, o‘chirish!',
        cancelButtonText: 'Bekor qilish',
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/question/categories/delete/${categoryId}/`, {
            method: 'DELETE',
            headers: {
              'X-CSRFToken': csrfToken,
              'X-Requested-With': 'XMLHttpRequest',
            },
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
              }
              return response.json();
            })
            .then((data) => {
              if (data.success) {
                Swal.fire({
                  title: 'Muvaffaqiyatli!',
                  text: data.message,
                  icon: 'success',
                  confirmButtonText: 'OK',
                }).then(() => {
                  window.location.reload(); // Reload the page
                });
              } else {
                Swal.fire({
                  title: 'Xatolik!',
                  text: data.message || 'Kategoriyani o\'chirishda xatolik yuz berdi.',
                  icon: 'error',
                  confirmButtonText: 'OK',
                });
              }
            })
            .catch((error) => {
              Swal.fire({
                title: 'Xatolik!',
                text: 'Server bilan bog‘lanishda xatolik yuz berdi.',
                icon: 'error',
                confirmButtonText: 'OK',
              });
              console.error('Error:', error);
            });
        }
      });
    }
  </script>

{% endblock script %}