{% extends 'question/main.html' %}
{% load static %}
{% block style %}
  <link rel="stylesheet" href="{% static 'assets/js/plugins/dropzone/min/dropzone.min.css' %}">

{% endblock style %}
<style>
    .card {
        border-radius: 10px;
        overflow: hidden;
    }

    .card-title {
        font-weight: 600;
    }

    .card-text {
        font-size: 0.9rem;
    }
</style>
{% block content %}
  <main id="main-container">
    <!-- Hero -->
    <div class="bg-image overflow-hidden"
         style="background-image: url('{% static "assets/media/photos/photo3@2x.jpg" %}');">
      <div class="bg-primary-dark-op">
        <div class="content content-full">
          <div
            class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center mt-5 mb-2 text-center text-sm-start">
            <div class="flex-grow-1">
              <h1 class="fw-semibold text-white mb-0">Kategoriyalar</h1>

            </div>
            <div class="flex-shrink-0 mt-3 mt-sm-0 ms-sm-3">
                  <span class="d-inline-block">
                    <a class="btn btn-primary px-4 py-2" href="{% url 'add-category' %}">
                      <i class="fa fa-plus me-1 opacity-50"></i> Kategoriya qo'shish
                    </a>
                  </span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- END Hero -->


    <hr>
    <!-- Page Content -->
    <div class="content">
      <div class="row">
        {% for category in categories %}
          <div class="col-md-4 mb-4">
            <div class="card shadow-sm h-100">
              <!-- Category Image -->
              <img
                src="
                  {% if category.image %}{{ category.image.url }}{% else %}{% static 'assets/media/default_category.png' %}{% endif %}"
                class="card-img-top"
                alt="{{ category.name }}"
                style="width: 100%; height: 200px; object-fit: cover; border-radius: 10px;">
              <div class="card-body d-flex flex-column">
                <!-- Category Details -->
                <h5 class="card-title">{{ category.name }}</h5>
                <p class="card-text text-muted">
                  {{ category.description|default:"Tavsif mavjud emas" }}
                </p>
                <h6 class="mt-3">Testlar:</h6>
                <ul class="list-group list-group-flush mb-3">
                  {% for test in category.tests.all %}
                    <li class="list-group-item">
                      <strong>{{ test.name }}</strong>
                      {% if test.questions.count > 0 %}
                        <ul class="mt-2">
                          {% for question in test.questions.all %}
                            <li class="text-muted small">{{ question.text }}</li>
                          {% endfor %}
                        </ul>
                      {% else %}
                        <p class="text-muted small">Savollar mavjud emas</p>
                      {% endif %}
                    </li>
                  {% empty %}
                    <li class="list-group-item text-center text-muted">Testlar mavjud emas</li>
                  {% endfor %}
                </ul>
                <!-- Action Buttons -->
                <div class="mt-auto d-flex justify-content-between">
                  <a href="{% url 'edit-category' category.id %}" class="btn btn-sm btn-primary">
                    <i class="fa fa-pencil-alt"></i> Tahrirlash
                  </a>
                  <button class="btn btn-sm btn-danger" onclick="deleteCategory({{ category.id }})">
                    <i class="fa fa-trash"></i> O‘chirish
                  </button>
                </div>
              </div>
            </div>
          </div>
        {% empty %}
          <div class="col-12">
            <p class="text-center text-muted">Kategoriyalar mavjud emas.</p>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- END Page Content -->
  </main>
{% endblock content %}

{% block script %}
  <!-- jQuery (required for Select2 + Bootstrap Maxlength plugin) -->
  <script src="{% static 'assets/js/lib/jquery.min.js' %}"></script>
  <script src="{% static 'assets/js/plugins/sweetalert2/sweetalert2.all.min.js' %}"></script>

  <script>
    function getCSRFToken() {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
          return value;
        }
      }
      console.error('CSRF token is missing in cookies!');
      return null;
    }

    function deleteCategory(categoryId) {
      const csrfToken = getCSRFToken();

      if (!csrfToken) {
        Swal.fire({
          title: 'Xatolik!',
          text: 'CSRF token topilmadi!',
          icon: 'error',
          confirmButtonText: 'OK',
        });
        return;
      }

      Swal.fire({
        title: 'Tasdiqlaysizmi?',
        text: 'Ushbu kategoriyani o‘chirmoqchimisiz?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Ha, o‘chirish!',
        cancelButtonText: 'Bekor qilish',
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/question/categories/delete/${categoryId}/`, {
            method: 'DELETE',
            headers: {
              'X-CSRFToken': csrfToken,
              'X-Requested-With': 'XMLHttpRequest',
            },
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
              }
              return response.json();
            })
            .then((data) => {
              if (data.success) {
                Swal.fire({
                  title: 'Muvaffaqiyatli!',
                  text: data.message,
                  icon: 'success',
                  confirmButtonText: 'OK',
                }).then(() => {
                  window.location.reload(); // Reload the page
                });
              } else {
                Swal.fire({
                  title: 'Xatolik!',
                  text: data.message || 'Kategoriyani o\'chirishda xatolik yuz berdi.',
                  icon: 'error',
                  confirmButtonText: 'OK',
                });
              }
            })
            .catch((error) => {
              Swal.fire({
                title: 'Xatolik!',
                text: 'Server bilan bog‘lanishda xatolik yuz berdi.',
                icon: 'error',
                confirmButtonText: 'OK',
              });
              console.error('Error:', error);
            });
        }
      });
    }
  </script>

{% endblock script %}