{% extends 'question/main.html' %}
{% load static %}
{% block style %}
  <link rel="stylesheet" href="{% static 'assets/js/plugins/dropzone/min/dropzone.min.css' %}">

{% endblock style %}

{% block content %}
  <main id="main-container">
    <!-- Hero -->
    <div class="bg-image overflow-hidden"
         style="background-image: url('{% static "assets/media/photos/photo3@2x.jpg" %}');">
      <div class="bg-primary-dark-op">
        <div class="content content-full">
          <div
            class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center mt-5 mb-2 text-center text-sm-start">
            <div class="flex-grow-1">
              <h1 class="fw-semibold text-white mb-0">Kategoriyalar</h1>
              <h2 class="h4 fw-normal text-white-75 mb-0">Yangi kategoriya qo'shish</h2>
            </div>
            <div class="flex-shrink-0 mt-3 mt-sm-0 ms-sm-3">
              <a class="btn btn-light px-4 py-2" href="{% url 'categories' %}">
                <i class="fa fa-arrow-left me-1 opacity-50"></i> Ortga
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- END Hero -->

    <!-- Page Content -->
    <div class="content">
      <div class="block block-rounded shadow-sm p-3 p-md-4">
        <form id="editCategoryForm" method="POST" action="{% url 'edit-category' category.id %}"
              enctype="multipart/form-data" class="row g-3">
          {% csrf_token %}

          <!-- Kategoriya nomi -->
          <div class="col-md-6">
            <label for="category-name" class="form-label fw-semibold small text-muted mb-1">Kategoriya nomi</label>
            <input type="text" name="name" id="category-name" class="form-control form-control-sm"
                   value="{{ category.name }}" required placeholder="Masalan: Fizika">
          </div>

          <!-- Ta'rif -->
          <div class="col-md-6">
            <label for="category-description" class="form-label fw-semibold small text-muted mb-1">Ta'rif</label>
            <textarea name="description" id="category-description" rows="3" class="form-control form-control-sm"
                      placeholder="Qisqacha ta'rif..." required>{{ category.description }}</textarea>
          </div>

          <!-- Rasm preview va yuklash -->
          <div class="col-12 text-center">
            <label class="form-label fw-semibold small text-muted mb-2 d-block">Kategoriya rasmi</label>
            <div class="position-relative mx-auto" style="width: 150px; height: 150px;">
              <img
                id="categoryImagePreview"
                src="


                  {% if category.image %}{{ category.image.url }}{% else %}{% static 'assets/media/various/ecom_product1.png' %}{% endif %}"
                alt="Kategoriya Rasmi"
                class="img-thumbnail rounded-circle border shadow-sm"
                style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;"
                onclick="document.getElementById('category-image').click();"
              >
              <input
                type="file"
                id="category-image"
                name="image"
                accept="image/*"
                class="d-none"
                onchange="previewCategoryImage(this);"
              >
              <div class="position-absolute bottom-0 end-0">
                <button type="button" class="btn btn-sm btn-primary rounded-circle px-2 py-1"
                        onclick="document.getElementById('category-image').click();">
                  <i class="fa fa-camera small"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Submit Button -->
          <div class="col-12 text-end mt-2">
            <button type="submit" class="btn btn-sm btn-alt-primary px-4 py-2" id="submitEditCategory">
              <i class="fa fa-save me-1 opacity-50"></i> Yangilash
            </button>
          </div>
        </form>
      </div>
    </div>

  </main>
{% endblock content %}

{% block script %}
  <!-- jQuery va SweetAlert -->
  <script src="{% static 'assets/js/lib/jquery.min.js' %}"></script>
  <script src="{% static 'assets/js/plugins/sweetalert2/sweetalert2.all.min.js' %}"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const submitBtn = document.getElementById('submitEditCategory');
      const form = document.getElementById('editCategoryForm');

      submitBtn.addEventListener('click', function() {
        Swal.fire({
          title: 'Tasdiqlaysizmi?',
          text: 'Kategoriyani yangilamoqchimisiz?',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Ha, yangilash!',
          cancelButtonText: 'Bekor qilish',
        }).then((result) => {
          if (result.isConfirmed) {
            const formData = new FormData(form);

            fetch(form.action, {
              method: 'POST',
              body: formData,
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
              },
            })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  Swal.fire({
                    title: 'Muvaffaqiyatli!',
                    text: data.message,
                    icon: 'success',
                    confirmButtonText: 'OK',
                  });
                } else {
                  Swal.fire({
                    title: 'Xatolik!',
                    text: data.message || 'Ma\'lumotni yangilashda xatolik yuz berdi.',
                    icon: 'error',
                    confirmButtonText: 'OK',
                  });
                }
              })
              .catch(error => {
                Swal.fire({
                  title: 'Xatolik!',
                  text: 'Server bilan bog\'lanishda xatolik yuz berdi.',
                  icon: 'error',
                  confirmButtonText: 'OK',
                });
                console.error('❌ Fetch xatosi:', error);
              });
          }
        });
      });

      // Kategoriya rasmi oldindan ko‘rish
      window.previewCategoryImage = function(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById('categoryImagePreview').src = e.target.result;
          };
          reader.readAsDataURL(input.files[0]);
        }
      };
    });
  </script>
{% endblock script %}