{% extends 'question/main.html' %}
{% load static %}
{% block style %}
{% endblock style %}

{% block content %}
    <main id="main-container">
        <!-- Hero -->
        <div class="bg-image overflow-hidden" style="background-image: url('{% static "assets/media/photos/photo3@2x.jpg" %}');">
          <div class="bg-primary-dark-op">
            <div class="content content-full">
              <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center mt-5 mb-2 text-center text-sm-start">
                <div class="flex-grow-1">
                  <h1 class="fw-semibold text-white mb-0">Users</h1>
                  <h2 class="h4 fw-normal text-white-75 mb-0">Welcome To Add User</h2>
                </div>
                <div class="mt-3 mt-sm-0">
                  <!-- Back Button -->
                  <a href="javascript:history.back()" class="btn btn-alt-secondary">
                    <i class="fa fa-arrow-left me-1"></i> Ortga
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- END Hero -->

        <!-- Page Content -->
        <div class="content">
          <!-- User Creation Form -->
          <div class="block block-rounded block-bordered">
            <div class="block-header block-header-default">
              <h3 class="block-title">Yangi foydalanuvchi yaratish</h3>
            </div>
            <div class="block-content">
              <!-- Form -->
              <form id="userForm" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="row">
                  <!-- First Name -->
                  <div class="col-md-4 mb-3">
                    <label class="form-label" for="first_name">Ism</label>
                    <input type="text" class="form-control" id="first_name" name="first_name" placeholder="Ismingizni kiriting" required>
                  </div>
                  <!-- Second Name -->
                  <div class="col-md-4 mb-3">
                    <label class="form-label" for="second_name">Familiya</label>
                    <input type="text" class="form-control" id="second_name" name="second_name" placeholder="Familiyangizni kiriting" required>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label" for="username">Foydalanuvchi nomi</label>
                    <input type="text" class="form-control" id="username" name="username" placeholder="Foydalanuvchi nomini kiriting" required>
                  </div>
                </div>
                <div class="row">
                  <!-- Phone Number -->
                  <div class="col-md-6 mb-3">
                    <label class="form-label" for="phone_number">Telefon raqam</label>
                    <input
                      type="text"
                      class="form-control"
                      id="phone_number"
                      name="phone_number"
                      placeholder="+998 XX XXX XX XX"
                      required
                    >
                  </div>
                  <!-- Address -->
                  <div class="col-md-6 mb-3">
                    <label class="form-label" for="address">Manzil</label>
                    <input type="text" class="form-control" id="address" name="address" placeholder="Manzilingizni kiriting" required>
                  </div>
                </div>
                <div class="row">
                  <!-- Date of Birth -->
                  <div class="col-md-6 mb-3">
                    <label class="form-label" for="date_of_birth">Tug'ilgan sana</label>
                    <input type="date" class="form-control" id="date_of_birth" name="date_of_birth" required>
                  </div>
                  <!-- Gender -->
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Jinsi</label>
                    <select class="form-select" name="gender" required>
                      <option value="" disabled selected>Tanlang</option>
                      <option value="male">Erkak</option>
                      <option value="female">Ayol</option>
                    </select>
                  </div>
                </div>
                <div class="row">
                  <!-- Nationality -->
                  <div class="col-md-6 mb-3">
                    <label class="form-label" for="nationality">Millati</label>
                    <select class="form-select" id="nationality" name="nationality" required>
                      <option value="" disabled selected>Millatingizni tanlang</option>
                      <option value="Uzbek">O'zbek</option>
                      <option value="Kazakh">Qozoq</option>
                      <option value="Kyrgyz">Qirg'iz</option>
                      <option value="Tajik">Tojik</option>
                      <option value="Turkmen">Turkman</option>
                      <option value="Afghan">Afg'on</option>
                      <option value="Pakistani">Pokistonlik</option>
                      <option value="Indian">Hind</option>
                      <option value="Chinese">Xitoylik</option>
                      <option value="Japanese">Yapon</option>
                      <option value="Korean">Koreys</option>
                      <option value="Malaysian">Malayziyalik</option>
                      <option value="Indonesian">Indoneziyalik</option>
                      <option value="Filipino">Filippinlik</option>
                      <option value="Vietnamese">Vetnamlik</option>
                      <option value="Thai">Tay</option>
                      <option value="Bangladeshi">Bangladeshlik</option>
                      <option value="Sri Lankan">Shri-Lankalik</option>
                      <option value="Nepali">Nepallik</option>
                      <option value="Mongolian">Mo'g'ul</option>
                      <option value="Iranian">Eronlik</option>
                      <option value="Iraqi">Iroqlik</option>
                      <option value="Saudi Arabian">Saudiya Arabistonlik</option>
                      <option value="Syrian">Suriya</option>
                      <option value="Jordanian">Iordaniyalik</option>
                      <option value="Palestinian">Falastinlik</option>
                      <option value="Turkish">Turk</option>
                      <option value="Armenian">Arman</option>
                      <option value="Azerbaijani">Ozarbayjonlik</option>
                      <option value="Georgian">Gruzin</option>
                    </select>
                  </div>
                  <!-- Profile Picture -->
                 <div class="col-md-6 mb-3 text-center">
                  <label class="form-label d-block">Profil rasmi</label>
                  <div class="position-relative" style="width: 150px; height: 150px; margin: auto;">
                    <img
                      id="profilePicturePreview"
                      src="{% static 'assets/media/avatars/avatar0.jpg' %}"
                      alt="Profil rasmi"
                      class="img-thumbnail rounded-circle"
                      style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;"
                      onclick="document.getElementById('profile_picture').click();"
                    >
                    <input
                      type="file"
                      id="profile_picture"
                      name="profile_picture"
                      accept="image/*"
                      style="display: none;"
                      onchange="previewProfilePicture(this); validateProfilePicture();"
                    >
                  </div>
                  <small id="profilePictureError" class="text-danger d-none">Iltimos, rasm yuklang.</small>
                </div>
                </div>
                <div class="row">
                  <!-- Bio -->
                  <div class="col-12 mb-3">
                    <label class="form-label" for="bio">Qo'shimcha ma'lumot (Bio)</label>
                    <textarea class="form-control" id="bio" name="bio" rows="4" placeholder="Qo'shimcha ma'lumot yozing" required></textarea>
                  </div>
                </div>
                <div class="row">
                  <!-- Is Teacher -->
                  <div class="col-md-6 mb-3">
                    <div class="form-check d-flex align-items-center">
                      <input class="form-check-input me-2" type="checkbox" id="is_teacher" name="is_teacher" required>
                      <label class="form-check-label d-flex align-items-center" for="is_teacher">
                        <i class="fas fa-chalkboard-teacher me-2 text-primary"></i> O'qituvchi
                      </label>
                    </div>
                  </div>
                  <!-- Is Student -->
                  <div class="col-md-6 mb-3">
                    <div class="form-check d-flex align-items-center">
                      <input class="form-check-input me-2" type="checkbox" id="is_student" name="is_student" required>
                      <label class="form-check-label d-flex align-items-center" for="is_student">
                        <i class="fas fa-user-graduate me-2 text-success"></i> Talaba
                      </label>
                    </div>
                  </div>
                </div>
                <!-- Submit Button -->
                <div class="text-end">
                  <button type="button" id="submitButton" class="btn btn-primary w-100 mb-2">
                    <i class="fas fa-save"></i> Saqlash
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </main>
{% endblock content %}

{% block script %}
  <script src="{% static 'assets/js/plugins/sweetalert2/sweetalert2.all.min.js' %}"></script>
  <script>
  function previewProfilePicture(input) {
    const preview = document.getElementById('profilePicturePreview');
    const errorText = document.getElementById('profilePictureError');
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function (e) {
        preview.src = e.target.result;
      };
      reader.readAsDataURL(input.files[0]);
      errorText.classList.add('d-none'); // Xatolik matnini yashirish
    }
  }

  function validateProfilePicture() {
    const input = document.getElementById('profile_picture');
    const errorText = document.getElementById('profilePictureError');
    if (!input.files || input.files.length === 0) {
      errorText.classList.remove('d-none'); // Xatolik matnini ko'rsatish
      input.classList.add('is-invalid'); // Inputga xato holatini qo'shish
      return false;
    } else {
      errorText.classList.add('d-none'); // Xatolik matnini yashirish
      input.classList.remove('is-invalid'); // Xato holatini olib tashlash
      return true;
    }
  }

  document.getElementById('submitButton').addEventListener('click', function (event) {
    event.preventDefault(); // Formani avtomatik yuborishni to'xtatish
    const isValidPicture = validateProfilePicture(); // Rasmni tekshirish
    const form = document.getElementById('userForm');
    let isValid = true;

    // Inputlar validatsiyasi
    form.querySelectorAll('input, select').forEach((input) => {
      if (!input.value) {
        input.classList.add('is-invalid');
        isValid = false;
      } else {
        input.classList.remove('is-invalid');
      }
    });

    // Agar rasm va boshqa inputlar valid bo'lsa
    if (isValid && isValidPicture) {
      Swal.fire({
        title: 'Tasdiqlaysizmi?',
        text: "Foydalanuvchini saqlamoqchimisiz?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Ha, saqlash!',
        cancelButtonText: 'Bekor qilish',
      }).then((result) => {
        if (result.isConfirmed) {
          const formData = new FormData(form);
          fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
            },
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                Swal.fire({
                  title: 'Muvaffaqiyatli!',
                  text: data.message,
                  icon: 'success',
                  confirmButtonText: 'OK',
                }).then(() => {
                  form.reset();
                  window.location.reload();
                });
              } else {
                Swal.fire({
                  title: 'Xatolik!',
                  text: data.message || 'Ma\'lumotlarni saqlashda xatolik yuz berdi!',
                  icon: 'error',
                  confirmButtonText: 'OK',
                });
              }
            })
            .catch((error) => {
              Swal.fire({
                title: 'Xatolik!',
                text: 'Server bilan bog\'lanishda xatolik yuz berdi!',
                icon: 'error',
                confirmButtonText: 'OK',
              });
              console.error('Xatolik:', error);
            });
        }
      });
    }
  });
</script>
  
  <script>
    function previewProfilePicture(input) {
      const preview = document.getElementById('profilePicturePreview');
  
      if (input.files && input.files[0]) {
        const reader = new FileReader();
  
        reader.onload = function (e) {
          preview.src = e.target.result;
        };
  
        reader.readAsDataURL(input.files[0]);
      }
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const phoneInput = document.getElementById('phone_number');
  
      phoneInput.addEventListener('input', function () {
        let value = phoneInput.value.replace(/\D/g, ''); // Faqat raqamlarni qoldiradi
        if (value.startsWith('998')) {
          value = value.slice(3); // Agar 998 bo'lsa, olib tashlaydi (raqam ichida formatlaymiz)
        }
  
        // Telefon raqam formatini qo'llash
        const formatted = '+998 ' + 
          (value.slice(0, 2) ? value.slice(0, 2) + ' ' : '') +
          (value.slice(2, 5) ? value.slice(2, 5) + ' ' : '') +
          (value.slice(5, 7) ? value.slice(5, 7) + ' ' : '') +
          (value.slice(7, 9) ? value.slice(7, 9) : '');
  
        phoneInput.value = formatted.trim(); // Formatlangan qiymatni inputga qo'yadi
      });
    });
  </script>
{% endblock script %}