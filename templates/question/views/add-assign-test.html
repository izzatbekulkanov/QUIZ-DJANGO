{% extends 'question/main.html' %}
{% load static %}
{% block style %}
  <link rel="stylesheet" href="{% static 'assets/js/plugins/dropzone/min/dropzone.min.css' %}">
{% endblock style %}
{% block content %}
  <main id="main-container">
    <!-- Hero -->
    <div class="bg-image overflow-hidden"
         style="background-image: url('{% static "assets/media/photos/photo3@2x.jpg" %}');">
      <div class="bg-primary-dark-op">
        <div class="content content-full">
          <div
            class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center mt-5 mb-2 text-center text-sm-start">
            <div class="flex-grow-1">
              <h1 class="fw-semibold text-white mb-0">Topshiriqlar</h1>
              <h2 class="h4 fw-normal text-white-75 mb-0"><code><i> Topshiriqlar qo'shish</i></code>
              </h2>
            </div>
            <div class="flex-shrink-0 mt-3 mt-sm-0 ms-sm-3">
              <div class="mt-3 mt-sm-0">
                <!-- Back Button -->
                <a href="{% url 'assign-test' %}" class="btn btn-alt-secondary">
                <i class="fa fa-arrow-left me-1"></i> Ortga
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- END Hero -->
    <!-- Page Content -->
    <div class="content">
      <div class="block block-rounded">
        <div class="block-header block-header-default">
          <h3 class="block-title">Testni Taqdim Etish</h3>
        </div>
        <div class="block-content">
          <form id="assign-test-form">
            {% csrf_token %}
            <!-- Kategoriya tanlash -->
            <div class="mb-4">
                <label class="form-label" for="category">Kategoriya</label>
                <select class="form-select" id="category" name="category" required>
                    <option value="" disabled selected>Tanlang...</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
        
            <!-- Test tanlash -->
            <div class="mb-4">
                <label class="form-label" for="test">Test</label>
                <select class="form-select" id="test" name="test" required>
                    <option value="" disabled selected>Avval kategoriyani tanlang...</option>
                </select>
            </div>
        
            <!-- Savollar soni -->
            <div class="mb-4">
                <label class="form-label" for="total_questions">Savollar soni</label>
                <input type="number" class="form-control" id="total_questions" name="total_questions" min="1"
                    placeholder="Savollar sonini kiriting" required>
                <div id="question-error" class="text-danger mt-1" style="display: none;">Savollar soni testdagi savollar
                    sonidan ko‘p bo‘lishi mumkin emas!</div>
            </div>
        
            <!-- Boshlanish va tugash vaqti -->
            <div class="mb-4">
                <label class="form-label" for="start_time">Boshlanish vaqti</label>
                <input type="datetime-local" class="form-control" id="start_time" name="start_time" required>
            </div>
            <div class="mb-4">
                <label class="form-label" for="end_time">Tugash vaqti</label>
                <input type="datetime-local" class="form-control" id="end_time" name="end_time" required>
                <div id="time-error" class="text-danger mt-1" style="display: none;">Tugash vaqti boshlanish vaqtidan katta
                    bo‘lishi kerak!</div>
            </div>
        
            <!-- Duration qo'shish -->
            <div class="mb-4">
                <label class="form-label" for="duration">Test davomiyligi (daqiqa)</label>
                <input type="number" class="form-control" id="duration" name="duration" min="1" placeholder="Davomiylikni kiriting" required>
            </div>
        
            <!-- Taqdim etish tugmasi -->
            <div class="mb-4 text-end">
                <button type="submit" class="btn btn-alt-primary">
                    <i class="fa fa-save me-1"></i> Taqdim Etish
                </button>
            </div>
        </form>
        </div>
      </div>
    </div>
    <!-- END Page Content -->
  </main>
{% endblock content %}
{% block script %}
  <!-- jQuery (required for Select2 + Bootstrap Maxlength plugin) -->
  <script src="{% static 'assets/js/lib/jquery.min.js' %}"></script>
  <script src="{% static 'assets/js/plugins/sweetalert2/sweetalert2.all.min.js' %}"></script>

  <script>
// Testdagi savollar soni
let availableQuestions = 0;

// Testlarni kategoriya asosida yuklash
document.getElementById('category').addEventListener('change', function () {
  const categoryId = this.value;
  const testSelect = document.getElementById('test');
  testSelect.innerHTML = '<option value="" disabled selected>Yuklanmoqda...</option>';

  fetch(`/question/fetch/tests/?category_id=${categoryId}`)
    .then(response => response.json())
    .then(data => {
      testSelect.innerHTML = '<option value="" disabled selected>Testni tanlang...</option>';
      data.tests.forEach(test => {
        const option = document.createElement('option');
        option.value = test.id;
        option.textContent = `${test.name} (${test.question_count} ta savol)`;
        option.dataset.questionCount = test.question_count; // Savollar sonini saqlash
        testSelect.appendChild(option);
      });
    })
    .catch(error => {
      console.error('Error fetching tests:', error);
      testSelect.innerHTML = '<option value="" disabled selected>Xatolik yuz berdi</option>';
    });
});

// Test tanlanganda savollar sonini aniqlash
document.getElementById('test').addEventListener('change', function () {
  availableQuestions = this.options[this.selectedIndex].dataset.questionCount || 0;
});

// Formani yuborishdan oldin tekshirish
document.getElementById('assign-test-form').addEventListener('submit', function (event) {
  event.preventDefault();

  const totalQuestions = parseInt(document.getElementById('total_questions').value, 10);
  const startTime = new Date(document.getElementById('start_time').value);
  const endTime = new Date(document.getElementById('end_time').value);

  // Savollar sonini tekshirish
  if (totalQuestions > availableQuestions) {
    const questionError = document.getElementById('question-error');
    questionError.style.display = 'block';
    return;
  } else {
    document.getElementById('question-error').style.display = 'none';
  }

  // Vaqtlarni tekshirish
  if (startTime >= endTime) {
    const timeError = document.getElementById('time-error');
    timeError.style.display = 'block';
    return;
  } else {
    document.getElementById('time-error').style.display = 'none';
  }

  // Formani yuborish
  const formData = new FormData(this);
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  fetch('{% url "add-assign-test" %}', {
    method: 'POST',
    body: formData,
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRFToken': csrfToken, // CSRF tokenni yuborish
    },
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        Swal.fire({
          title: 'Muvaffaqiyatli!',
          text: data.message,
          icon: 'success',
          confirmButtonText: 'OK',
        }).then(() => {
          this.reset(); // Formani tozalash
        });
      } else {
        Swal.fire({
          title: 'Xatolik!',
          text: data.message || 'Taqdim etishda xatolik yuz berdi.',
          icon: 'error',
          confirmButtonText: 'OK',
        });
      }
    })
    .catch(error => {
      console.error('Error submitting form:', error);
      Swal.fire({
        title: 'Xatolik!',
        text: 'Server bilan bog‘lanishda muammo yuz berdi.',
        icon: 'error',
        confirmButtonText: 'OK',
      });
    });
});
</script>
{% endblock script %}