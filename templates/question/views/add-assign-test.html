{% extends 'question/main.html' %}
{% load static %}
{% block style %}
  <link rel="stylesheet" href="{% static 'assets/js/plugins/dropzone/min/dropzone.min.css' %}">
{% endblock style %}
{% block content %}

  <main id="main-container">
    <!-- Hero -->
    <div class="bg-image overflow-hidden"
         style="background-image: url('{% static "assets/media/photos/photo3@2x.jpg" %}');">
      <div class="bg-primary-dark-op">
        <div class="content content-full">
          <div
            class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center mt-5 mb-2 text-center text-sm-start">
            <div class="flex-grow-1">
              <h1 class="fw-semibold text-white mb-0">Topshiriqlar</h1>
              <h2 class="h4 fw-normal text-white-75 mb-0">Topshiriqlar qo'shish</h2>
            </div>
            <div class="mt-3 mt-sm-0">
              <!-- Back Button -->
              <a href="javascript:history.back()" class="btn btn-alt-secondary">
                <i class="fa fa-arrow-left me-1"></i> Ortga
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- END Hero -->
    <!-- Page Content -->
    <div class="content">
      <!-- Add Test Form -->
      <h2 class="content-heading">Yangi Test Topshiriq Qo‘shish</h2>
      <form id="add-assignment-form" method="post">
    {% csrf_token %}
    <div class="form-group mb-3">
        <label for="category_id">Kategoriya:</label>
        <select id="category_id" name="category_id" class="form-control" required data-url="{% url 'category-tests' %}">
            <option value="">Kategoriya tanlang</option>
            {% for category in categories %}
            <option value="{{ category.id }}">{{ category.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="form-group mb-3">
        <label for="test_id">Test:</label>
        <select id="test_id" name="test_id" class="form-control" required>
            <option value="">Avval kategoriya tanlang</option>
        </select>
    </div>
    <div class="form-group mb-3">
        <label for="total_questions">Savollar soni:</label>
        <input type="number" id="total_questions" name="total_questions" class="form-control" required min="1">
    </div>
    <div class="form-group mb-3">
        <label for="start_time">Boshlanish vaqti:</label>
        <input type="datetime-local" id="start_time" name="start_time" class="form-control" required>
    </div>
    <div class="form-group mb-3">
        <label for="end_time">Tugash vaqti:</label>
        <input type="datetime-local" id="end_time" name="end_time" class="form-control" required>
    </div>
    <div class="form-group mb-3">
        <label for="duration">Davomiylik (daqiqa):</label>
        <input type="number" id="duration" name="duration" class="form-control" required min="1" value="30">
    </div>
    <button type="submit" class="btn btn-primary">Qo‘shish</button>
</form>
    </div>
  </main>
{% endblock content %}
{% block script %}
  <!-- jQuery (required for Select2 + Bootstrap Maxlength plugin) -->
  <script src="{% static 'assets/js/lib/jquery.min.js' %}"></script>
  <script src="{% static 'assets/js/plugins/sweetalert2/sweetalert2.all.min.js' %}"></script>

  <script>
document.addEventListener('DOMContentLoaded', function () {
    const categorySelect = document.getElementById('category_id');
    const testSelect = document.getElementById('test_id');
    const totalQuestionsInput = document.getElementById('total_questions');
    const form = document.getElementById('add-assignment-form');

    let maxQuestions = 0; // Tanlangan testning savollar soni

    // Kategoriya o'zgarganda testlarni yuklash
    categorySelect.addEventListener('change', function () {
        const categoryId = this.value;
        const url = this.getAttribute('data-url');

        testSelect.innerHTML = '<option value="">Test yuklanmoqda...</option>';

        if (categoryId) {
            fetch(`${url}?category_id=${categoryId}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        testSelect.innerHTML = '<option value="">Test tanlang</option>';
                        data.tests.forEach((test) => {
                            const option = document.createElement('option');
                            option.value = test.id;
                            option.textContent = test.name;
                            testSelect.appendChild(option);
                        });
                        Swal.fire('Muvaffaqiyatli', 'Kategoriya bo‘yicha testlar yuklandi!', 'success');
                    } else {
                        Swal.fire('Xatolik', data.message || 'Testlarni yuklashda muammo yuz berdi.', 'error');
                    }
                })
                .catch((error) => {
                    console.error('AJAX xatolik:', error);
                    Swal.fire('Xatolik', 'Server bilan bog‘lanishda muammo.', 'error');
                });
        } else {
            testSelect.innerHTML = '<option value="">Avval kategoriya tanlang</option>';
            Swal.fire('Eslatma', 'Iltimos, kategoriya tanlang.', 'info');
        }
    });

    // Test o'zgarganda maksimal savollar sonini olish
    testSelect.addEventListener('change', function () {
        const testId = this.value;
        if (testId) {
            fetch(`/question/test-questions-count/?test_id=${testId}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        maxQuestions = data.total_questions;
                        Swal.fire(
                            'Muvaffaqiyatli',
                            `Ushbu test uchun jami ${maxQuestions} ta savol mavjud.`,
                            'success'
                        );
                    } else {
                        Swal.fire('Xatolik', data.message || 'Savollar sonini olishda muammo yuz berdi.', 'error');
                    }
                })
                .catch((error) => {
                    console.error('AJAX xatolik:', error);
                    Swal.fire('Xatolik', 'Server bilan bog‘lanishda muammo.', 'error');
                });
        } else {
            maxQuestions = 0;
            Swal.fire('Eslatma', 'Iltimos, test tanlang.', 'info');
        }
    });

    // Validatsiya qilish
    totalQuestionsInput.addEventListener('input', function () {
        const enteredValue = parseInt(this.value, 10);
        if (enteredValue > maxQuestions) {
            Swal.fire(
                'Xatolik',
                `Kiritilgan savollar soni ${maxQuestions} dan oshmasligi kerak.`,
                'error'
            );
            this.value = maxQuestions; // Maksimal qiymatga qaytarish
        }
    });

    // Formni yuborish va muvaffaqiyatli qaytishni Swal orqali ko‘rsatish
    form.addEventListener('submit', function (event) {
        event.preventDefault(); // Formni avtomatik yuborilishini to‘xtatish

        const formData = new FormData(form);
        const url = form.action;

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    Swal.fire({
                        title: 'Muvaffaqiyatli!',
                        text: data.message,
                        icon: 'success',
                        confirmButtonText: 'OK',
                    }).then(() => {
                        // Sahifani yangilash yoki boshqa sahifaga o'tish
                        window.location.href = '{% url 'assign-test' %}'; // Kerakli URLni o'zgartiring
                    });
                } else {
                    Swal.fire({
                        title: 'Xatolik!',
                        text: data.message,
                        icon: 'error',
                        confirmButtonText: 'OK',
                    });
                }
            })
            .catch((error) => {
                console.error('AJAX xatolik:', error);
                Swal.fire({
                    title: 'Xatolik!',
                    text: 'Server bilan bog‘lanishda muammo.',
                    icon: 'error',
                    confirmButtonText: 'OK',
                });
            });
    });
});
  </script>
{% endblock script %}