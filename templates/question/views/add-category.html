{% extends 'question/main.html' %}
{% load static %}
{% block style %}
  <link rel="stylesheet" href="{% static 'assets/js/plugins/dropzone/min/dropzone.min.css' %}">
  
{% endblock style %}

{% block content %}
    <main id="main-container">
        <!-- Hero -->
        <div class="bg-image overflow-hidden" style="background-image: url('{% static "assets/media/photos/photo3@2x.jpg" %}');">
          <div class="bg-primary-dark-op">
            <div class="content content-full">
              <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center mt-5 mb-2 text-center text-sm-start">
                <div class="flex-grow-1">
                  <h1 class="fw-semibold text-white mb-0">Kategoriyalar</h1>
                  <h2 class="h4 fw-normal text-white-75 mb-0">Yangi kategoriya qo'shish</h2>
                </div>
                <div class="flex-shrink-0 mt-3 mt-sm-0 ms-sm-3">
                  <a class="btn btn-light px-4 py-2" href="{% url 'categories' %}">
                    <i class="fa fa-arrow-left me-1 opacity-50"></i> Ortga
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- END Hero -->

        <!-- Page Content -->
        <div class="content">
          <!-- Add Category -->
          <div class="block block-rounded">
            <div class="block-header block-header-default">
              <h3 class="block-title">Yangi Kategoriya Qo'shish</h3>
            </div>
            <div class="block-content">
              <div class="row justify-content-center">
                <div class="col-md-10 col-lg-8">
                  <form id="addCategoryForm" method="POST" action="{% url 'add-category' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <!-- Category Name -->
                    <div class="mb-4">
                      <label class="form-label" for="category-name">Kategoriya Nomi</label>
                      <input type="text" class="form-control" id="category-name" name="name" placeholder="Kategoriya nomini kiriting" required>
                    </div>
                    <!-- Description -->
                    <div class="mb-4">
                      <label class="form-label" for="category-description">Kategoriya Ta'rifi</label>
                      <textarea class="form-control" id="category-description" name="description" rows="4" placeholder="Kategoriya haqida ma'lumot kiriting"></textarea>
                    </div>
                    <!-- Image Upload -->
                    <div class="mb-4 text-center">
                      <label class="form-label d-block">Kategoriya Rasmi</label>
                      <div class="position-relative" style="width: 150px; height: 150px; margin: auto;">
                        <img
                          id="categoryImagePreview"
                          src="{% static 'assets/media/various/ecom_product1.png' %}"
                          alt="Kategoriya Rasmi"
                          class="img-thumbnail rounded-circle"
                          style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;"
                          onclick="document.getElementById('category-image').click();"
                        >
                        <input
                          type="file"
                          id="category-image"
                          name="image"
                          accept="image/*"
                          style="display: none;"
                          onchange="previewCategoryImage(this);"
                        >
                        <div class="position-absolute bottom-0 end-0">
                          <button type="button" class="btn btn-sm btn-primary" onclick="document.getElementById('category-image').click();">
                            <i class="fa fa-camera"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                    <!-- Submit Button -->
                    <div class="mb-4 text-end">
                      <button type="submit" class="btn btn-alt-primary">
                        <i class="fa fa-save me-1 opacity-50"></i> Saqlash
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
          <!-- END Add Category -->
        </div>
        <!-- END Page Content -->

      </main>
{% endblock content %}

{% block script %}
        <!-- jQuery (required for Select2 + Bootstrap Maxlength plugin) -->
    <script src="{% static 'assets/js/lib/jquery.min.js' %}"></script>
    <script src="{% static 'assets/js/plugins/sweetalert2/sweetalert2.all.min.js' %}"></script>

    <script>
      function previewCategoryImage(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            document.getElementById('categoryImagePreview').src = e.target.result;
          };
          reader.readAsDataURL(input.files[0]);
        }
      }
    </script>

    <script>
      // Rasmlarni oldindan ko'rish uchun funksiya
      function previewCategoryImage(input) {
        const preview = document.getElementById('categoryImagePreview');
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            preview.src = e.target.result;
          };
          reader.readAsDataURL(input.files[0]);
        }
      }
    
      // Formani yuborish uchun JavaScript
      document.getElementById('addCategoryForm').addEventListener('submit', function (e) {
        e.preventDefault(); // Formani avtomatik yuborishni to'xtatadi
        const form = this;
    
        Swal.fire({
          title: 'Tasdiqlaysizmi?',
          text: "Yangi kategoriyani qo'shmoqchimisiz?",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Ha, qo\'shish!',
          cancelButtonText: 'Bekor qilish',
        }).then((result) => {
          if (result.isConfirmed) {
            const formData = new FormData(form);
    
            fetch(form.action, {
              method: 'POST',
              body: formData,
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
              },
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  Swal.fire({
                    title: 'Muvaffaqiyatli!',
                    text: data.message,
                    icon: 'success',
                    confirmButtonText: 'OK',
                  }).then(() => {
                    form.reset(); // Formani tozalash
                    document.getElementById('categoryImagePreview').src = "{% static 'assets/media/various/ecom_product1.png' %}"; // Rasmni default ko'rinishga o'zgartirish
                    window.location.href = '{% url "categories" %}'; // Sahifani qayta yo'naltirish
                  });
                } else {
                  Swal.fire({
                    title: 'Xatolik!',
                    text: data.message,
                    icon: 'error',
                    confirmButtonText: 'OK',
                  });
                }
              })
              .catch((error) => {
                Swal.fire({
                  title: 'Xatolik!',
                  text: 'Ma ºlumot yuborishda xatolik yuz berdi.',
                  icon: 'error',
                  confirmButtonText: 'OK',
                });
                console.error('Error:', error);
              });
          }
        });
      });
    </script>
{% endblock script %}