{% extends 'question/main.html' %}
{% load static %}

{% block style %}
<link rel="stylesheet" href="{% static 'assets/js/plugins/dropzone/min/dropzone.min.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock style %}

{% block content %}
<main id="main-container" class="container-fluid px-0">
  <!-- Hero -->
  <div class="bg-primary bg-opacity-75 py-4" style="background-image: url('{% static 'assets/media/photos/photo3@2x.jpg' %}'); background-size: cover; background-position: center;">
    <div class="container">
      <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center my-4 text-center text-sm-start">
        <div class="flex-grow-1">
          <h1 class="fw-semibold text-white mb-0">Topshiriqlar</h1>
          <h2 class="h4 fw-normal text-white-75 mb-0">Topshiriqni tahrirlash</h2>
        </div>
        <div class="mt-3 mt-sm-0">
          <a href="{% url 'assign-test' %}" class="btn btn-outline-secondary">
            <i class="fa fa-arrow-left me-1"></i> Ortga
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Page Content -->
  <div class="container my-4">
    <div class="card shadow-sm">
      <div class="card-body p-4">
        <h2 class="card-title mb-4">Test Topshiriqni Tahrirlash</h2>
        <form id="edit-assignment-form" method="post">
          {% csrf_token %}
          <div class="mb-3">
            <label for="category_id" class="form-label">Kategoriya</label>
            <select id="category_id" name="category_id" class="form-select" required data-url="{% url 'category-tests' %}">
              <option value="" disabled>Kategoriya tanlang</option>
              {% for category in categories %}
                <option value="{{ category.id }}" {% if filters.category_id|stringformat:"s" == category.id|stringformat:"s" %}selected{% endif %}>
                  {{ category.name }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="test_id" class="form-label">Test</label>
            <select id="test_id" name="test_id" class="form-select" required>
              <option value="" disabled>Avval kategoriya tanlang</option>
              <option value="{{ filters.test_id }}" selected>{{ assignment.test.name }}</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="total_questions" class="form-label">Savollar soni</label>
            <input type="number" id="total_questions" name="total_questions" class="form-control" required min="1" value="{{ filters.total_questions }}">
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="start_time" class="form-label">Boshlanish vaqti</label>
              <input type="text" id="start_time" name="start_time" class="form-control" required placeholder="YYYY-MM-DD HH:mm" value="{{ filters.start_time }}">
            </div>
            <div class="col-md-6">
              <label for="end_time" class="form-label">Tugash vaqti</label>
              <input type="text" id="end_time" name="end_time" class="form-control" required placeholder="YYYY-MM-DD HH:mm" value="{{ filters.end_time }}">
            </div>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="duration" class="form-label">Davomiylik (daqiqa)</label>
              <input type="number" id="duration" name="duration" class="form-control" required min="1" value="{{ filters.duration }}">
            </div>
            <div class="col-md-6">
              <label for="max_attempts" class="form-label">Maksimal urinishlar soni</label>
              <input type="number" id="max_attempts" name="max_attempts" class="form-control" required min="1" value="{{ filters.max_attempts }}">
            </div>
          </div>
          <div class="text-end">
            <button type="submit" class="btn btn-primary">Saqlash</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</main>
{% endblock content %}

{% block script %}
<script src="{% static 'assets/js/lib/jquery.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="{% static 'assets/js/plugins/sweetalert2/sweetalert2.all.min.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const categorySelect = document.getElementById('category_id');
    const testSelect = document.getElementById('test_id');
    const totalQuestionsInput = document.getElementById('total_questions');
    const startTimeInput = document.getElementById('start_time');
    const endTimeInput = document.getElementById('end_time');
    const durationInput = document.getElementById('duration');
    const maxAttemptsInput = document.getElementById('max_attempts');
    const form = document.getElementById('edit-assignment-form');

    let maxQuestions = 0;

    // Initialize Flatpickr for datetime inputs
    flatpickr([startTimeInput, endTimeInput], {
      enableTime: true,
      dateFormat: "Y-m-d H:i",
      time_24hr: true,
      minuteIncrement: 1,
      placeholder: "YYYY-MM-DD HH:mm"
    });

    // Populate test select with current category tests
    const initialCategoryId = categorySelect.value;
    if (initialCategoryId) {
      fetchTests(initialCategoryId);
    }

    // Fetch tests based on category selection
    categorySelect.addEventListener('change', async () => {
      const categoryId = categorySelect.value;
      const url = categorySelect.dataset.url;
      testSelect.innerHTML = '<option value="" disabled>Test yuklanmoqda...</option>';

      if (categoryId) {
        await fetchTests(categoryId);
      } else {
        testSelect.innerHTML = '<option value="" disabled selected>Avval kategoriya tanlang</option>';
        Swal.fire({
          title: 'Eslatma',
          text: 'Iltimos, kategoriya tanlang.',
          icon: 'info',
          confirmButtonText: 'OK'
        });
      }
    });

    // Fetch question count based on test selection
    testSelect.addEventListener('change', async () => {
      const testId = testSelect.value;
      if (testId) {
        try {
          const response = await fetch(`/question/test-questions-count/?test_id=${testId}`);
          const data = await response.json();
          if (data.success) {
            maxQuestions = data.total_questions;
            Swal.fire({
              title: 'Muvaffaqiyatli',
              text: `Ushbu test uchun jami ${maxQuestions} ta savol mavjud.`,
              icon: 'success',
              confirmButtonText: 'OK'
            });
          } else {
            Swal.fire({
              title: 'Xatolik',
              text: data.message || 'Savollar sonini olishda muammo yuz berdi.',
              icon: 'error',
              confirmButtonText: 'OK'
            });
          }
        } catch (error) {
          Swal.fire({
            title: 'Xatolik',
            text: 'Server bilan bog‘lanishda muammo.',
            icon: 'error',
            confirmButtonText: 'OK'
          });
          console.error('Error:', error);
        }
      } else {
        maxQuestions = 0;
        Swal.fire({
          title: 'Eslatma',
          text: 'Iltimos, test tanlang.',
          icon: 'info',
          confirmButtonText: 'OK'
        });
      }
    });

    // Validate total questions input
    totalQuestionsInput.addEventListener('input', () => {
      const enteredValue = parseInt(totalQuestionsInput.value, 10);
      if (enteredValue > maxQuestions && maxQuestions > 0) {
        Swal.fire({
          title: 'Xatolik',
          text: `Kiritilgan savollar soni ${maxQuestions} dan oshmasligi kerak.`,
          icon: 'error',
          confirmButtonText: 'OK'
        });
        totalQuestionsInput.value = maxQuestions;
      }
    });

    // Validate max attempts input
    maxAttemptsInput.addEventListener('input', () => {
      const enteredValue = parseInt(maxAttemptsInput.value, 10);
      if (enteredValue < 1) {
        Swal.fire({
          title: 'Xatolik',
          text: 'Maksimal urinishlar soni 1 dan kam bo‘lishi mumkin emas.',
          icon: 'error',
          confirmButtonText: 'OK'
        });
        maxAttemptsInput.value = 1;
      }
    });

    // Validate duration input
    durationInput.addEventListener('input', () => {
      const enteredValue = parseInt(durationInput.value, 10);
      if (enteredValue < 1) {
        Swal.fire({
          title: 'Xatolik',
          text: 'Davomiylik 1 daqiqadan kam bo‘lishi mumkin emas.',
          icon: 'error',
          confirmButtonText: 'OK'
        });
        durationInput.value = 1;
      }
    });

    // Form submission with validation
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const startTime = new Date(startTimeInput.value);
      const endTime = new Date(endTimeInput.value);
      const now = new Date();

      if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
        Swal.fire({
          title: 'Xatolik',
          text: 'Boshlanish yoki tugash vaqti noto‘g‘ri formatda kiritilgan.',
          icon: 'error',
          confirmButtonText: 'OK'
        });
        return;
      }

      if (startTime >= endTime) {
        Swal.fire({
          title: 'Xatolik',
          text: 'Boshlanish vaqti tugash vaqtidan keyin bo‘lishi mumkin emas.',
          icon: 'error',
          confirmButtonText: 'OK'
        });
        return;
      }

      if (endTime <= now) {
        Swal.fire({
          title: 'Xatolik',
          text: 'Tugash vaqti hozirgi vaqtdan oldin bo‘lishi mumkin emas.',
          icon: 'error',
          confirmButtonText: 'OK'
        });
        return;
      }

      try {
        const formData = new FormData(form);
        const response = await fetch(form.action, {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        if (data.success) {
          Swal.fire({
            title: 'Muvaffaqiyatli!',
            text: data.message,
            icon: 'success',
            confirmButtonText: 'OK'
          }).then(() => {
            window.location.href = '{% url 'assign-test' %}';
          });
        } else {
          Swal.fire({
            title: 'Xatolik!',
            text: data.message || 'Topshiriqni tahrirlashda xato yuz berdi.',
            icon: 'error',
            confirmButtonText: 'OK'
          });
        }
      } catch (error) {
        Swal.fire({
          title: 'Xatolik!',
          text: 'Server bilan bog‘lanishda muammo.',
          icon: 'error',
          confirmButtonText: 'OK'
        });
        console.error('Error:', error);
      }
    });

    // Function to fetch tests for a category
    async function fetchTests(categoryId) {
      const url = categorySelect.dataset.url;
      try {
        const response = await fetch(`${url}?category_id=${categoryId}`);
        const data = await response.json();
        testSelect.innerHTML = '<option value="" disabled>Test tanlang</option>';
        if (data.success) {
          data.tests.forEach(test => {
            const option = document.createElement('option');
            option.value = test.id;
            option.textContent = test.name;
            if (test.id == '{{ filters.test_id }}') {
              option.selected = true;
            }
            testSelect.appendChild(option);
          });
          Swal.fire({
            title: 'Muvaffaqiyatli',
            text: 'Kategoriya bo‘yicha testlar yuklandi!',
            icon: 'success',
            confirmButtonText: 'OK'
          });
          // Fetch question count for the current test
          if ('{{ filters.test_id }}') {
            fetchQuestionCount('{{ filters.test_id }}');
          }
        } else {
          Swal.fire({
            title: 'Xatolik',
            text: data.message || 'Testlarni yuklashda muammo yuz berdi.',
            icon: 'error',
            confirmButtonText: 'OK'
          });
        }
      } catch (error) {
        Swal.fire({
          title: 'Xatolik',
          text: 'Server bilan bog‘lanishda muammo.',
          icon: 'error',
          confirmButtonText: 'OK'
        });
        console.error('Error:', error);
      }
    }

    // Function to fetch question count for a test
    async function fetchQuestionCount(testId) {
      try {
        const response = await fetch(`/question/test-questions-count/?test_id=${testId}`);
        const data = await response.json();
        if (data.success) {
          maxQuestions = data.total_questions;
        } else {
          Swal.fire({
            title: 'Xatolik',
            text: data.message || 'Savollar sonini olishda muammo yuz berdi.',
            icon: 'error',
            confirmButtonText: 'OK'
          });
        }
      } catch (error) {
        Swal.fire({
          title: 'Xatolik',
          text: 'Server bilan bog‘lanishda muammo.',
          icon: 'error',
          confirmButtonText: 'OK'
        });
        console.error('Error:', error);
      }
    }
  });
</script>
{% endblock script %}