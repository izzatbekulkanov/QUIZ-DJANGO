{% extends 'question/main.html' %}
{% load static %}

{% block style %}
  <style>
      .content {
          max-width: 1200px;
          margin: 0 auto;
      }

      .filter-group {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          flex-wrap: wrap;
      }

      .filter-group .form-select {
          width: auto;
          min-width: 150px;
          font-size: 0.8rem;
      }

      .input-group-sm .form-control {
          font-size: 0.8rem;
      }

      .block-rounded {
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
          border-radius: 8px;
      }

      .table-sm th, .table-sm td {
          padding: 0.3rem;
          font-size: 0.75rem;
          vertical-align: middle;
      }

      .table-sm img {
          width: 30px;
          height: 30px;
          object-fit: cover;
      }

      .btn-sm {
          padding: 0.2rem 0.4rem;
          font-size: 0.75rem;
      }

      .badge {
          font-size: 0.7rem;
      }

      .pagination-sm .page-link {
          font-size: 0.75rem;
          padding: 0.2rem 0.5rem;
      }

      .block-link-shadow:hover {
          transform: translateY(-2px);
          transition: transform 0.2s ease;
      }

      .auth-toggle {
          cursor: pointer;
      }
  </style>
{% endblock style %}

{% block content %}
  <main id="main-container">
    <div class="content py-3">
      <!-- Quick Overview -->
      <div class="row g-3">
        <div class="col-6 col-lg-3">
          <a class="block block-rounded block-link-shadow text-center" href="javascript:void(0)">
            <div class="block-content block-content-full">
              <div class="fs-2 fw-semibold text-dark">{{ total_users_count }}</div>
            </div>
            <div class="block-content py-2 bg-body-light">
              <p class="fw-medium fs-sm text-muted mb-0">Jami foydalanuvchilar</p>
            </div>
          </a>
        </div>
        <div class="col-6 col-lg-3">
          <a class="block block-rounded block-link-shadow text-center" href="javascript:void(0)">
            <div class="block-content block-content-full">
              <div class="fs-2 fw-semibold text-dark">{{ today_users_count }}</div>
            </div>
            <div class="block-content py-2 bg-body-light">
              <p class="fw-medium fs-sm text-muted mb-0">Bugun qo'shilgan</p>
            </div>
          </a>
        </div>
        <div class="col-6 col-lg-3">
          <a class="block block-rounded block-link-shadow text-center" href="javascript:void(0)">
            <div class="block-content block-content-full">
              <div class="fs-2 fw-semibold text-dark">{{ yesterday_users_count }}</div>
            </div>
            <div class="block-content py-2 bg-body-light">
              <p class="fw-medium fs-sm text-muted mb-0">Kecha qo'shilgan</p>
            </div>
          </a>
        </div>
        <div class="col-6 col-lg-3">
          <a class="block block-rounded block-link-shadow text-center" href="javascript:void(0)">
            <div class="block-content block-content-full">
              <div class="fs-2 fw-semibold text-dark">{{ month_users_count }}</div>
            </div>
            <div class="block-content py-2 bg-body-light">
              <p class="fw-medium fs-sm text-muted mb-0">Ushbu oyda qo'shilgan</p>
            </div>
          </a>
        </div>
      </div>

      <!-- All Users -->
      <div class="block block-rounded">
        <div class="block-header block-header-default d-flex justify-content-between align-items-center">
          <h3 class="block-title mb-0">Foydalanuvchilar</h3>
          <div class="d-flex align-items-center gap-2">
            <div class="dropdown">
              <button class="btn btn-sm btn-success dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fa fa-upload me-1"></i> Yuklash
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="startImport('staff', 'Hodimlar')">
                  <i class="fa fa-user-tie text-success me-1"></i> Hodimlar</a></li>
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="startImport('students', 'Talabalar')">
                  <i class="fa fa-user-graduate text-primary me-1"></i> Talabalar</a></li>
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="showGroupImport()">
                  <i class="fa fa-users text-info me-1"></i> Guruh bo‘yicha yuklash</a></li>
              </ul>
            </div>
            <a class="btn btn-sm btn-warning" href="{% url 'encoding' %}">
              <i class="fa fa-camera me-1"></i> Encoding yaratish
            </a>
            <a class="btn btn-sm btn-info" href="{% url 'add-user' %}">
              <i class="fa fa-plus me-1"></i> Yangi
            </a>
          </div>
        </div>

        <!-- Guruh tanlash oynasi -->
        <div id="group-import-container" class="mt-3 block-content" style="display: none;">
          <div class="d-flex align-items-center gap-2">
            <select id="group-select" class="form-select form-select-sm">
              <option value="">Guruhni tanlang</option>
              {% for group in groups %}
                <option value="{{ group.group_name }}">{{ group.group_name }}</option>
              {% endfor %}
            </select>
            <button class="btn btn-sm btn-primary" onclick="startGroupImport()">
              <i class="fa fa-upload me-1"></i> Yuklash
            </button>
          </div>
          <div id="error-alert" class="alert alert-danger d-none mt-2" role="alert"></div>
        </div>

        <div class="block-content">
          <form method="GET" class="mb-3">
            <div class="d-flex filter-group">
              <div class="input-group input-group-sm flex-grow-1 me-2">
                <input type="text" name="search" id="search" value="{{ search_query }}" class="form-control"
                       placeholder="Foydalanuvchi qidirish...">
                <button class="btn btn-light" type="submit"><i class="fa fa-search"></i></button>
              </div>
              <select class="form-select form-select-sm" name="filter_type" id="filter_type"
                      onchange="this.form.submit()">
                <option value="" {% if not filter_type %}selected{% endif %}>Hammasi</option>
                <option value="student" {% if filter_type == 'student' %}selected{% endif %}>Talaba</option>
                <option value="teacher" {% if filter_type == 'teacher' %}selected{% endif %}>Hodim</option>
                <option value="other" {% if filter_type == 'other' %}selected{% endif %}>Boshqa</option>
                <option value="group" {% if filter_type == 'group' %}selected{% endif %}>Guruh bo'yicha</option>
              </select>
              {% if filter_type == 'group' %}
                <select class="form-select form-select-sm ms-2" name="group_name" id="group_name"
                        onchange="this.form.submit()">
                  <option value="" {% if not group_name %}selected{% endif %}>Barcha guruhlar</option>
                  {% for group in groups %}
                    <option value="{{ group.group_name }}"
                            {% if group_name == group.group_name %}selected{% endif %}>{{ group.group_name }}</option>
                  {% endfor %}
                </select>
              {% endif %}
            </div>
          </form>

          <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

          <div class="table-responsive">
            <table class="table table-sm table-striped table-bordered align-middle text-center">
              <thead class="table-light">
              <tr>
                <th style="width: 40px;">#</th>
                <th>Username</th>
                <th>Ism</th>
                <th>Familiya</th>
                <th>Guruh</th>
                <th>Holati</th>
                <th>Tug'ilgan sana</th>
                <th>Rasm</th>
                <th>Auth</th>
                <th>Harakat</th>
              </tr>
              </thead>
              <tbody>
              {% for user in users %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ user.username|default:"–" }}</td>
                  <td>{{ user.first_name|default:"–" }}</td>
                  <td>{{ user.second_name|default:"–" }}</td>
                  <td>{{ user.group_name|default:"<span class='text-danger'>Biriktirilmagan</span>"|safe }}</td>
                  <td>
                    {% if user.is_student %}
                      Talaba {% if user.level_name %}({{ user.level_name }}){% endif %}
                    {% elif user.is_teacher %}
                      O‘qituvchi {% if user.staff_position %}({{ user.staff_position }}){% endif %}
                    {% else %}
                      Boshqa
                    {% endif %}
                  </td>
                  <td>{{ user.date_of_birth|date:"Y-m-d"|default:"–" }}</td>
                  <td>
                    <img src="
                      {% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}{% static 'assets/media/avatars/default-avatar.jpg' %}{% endif %}"
                         alt="Avatar" class="rounded-circle">
                  </td>
                  <td>
                    <input type="checkbox" class="auth-toggle" data-user-id="{{ user.id }}"
                           {% if user.auth_is_id %}checked{% endif %}>
                  </td>
                  <td>
                    <a href="{% url 'edit-user' user.id %}" class="btn btn-sm btn-alt-primary" data-bs-toggle="tooltip"
                       title="Tahrirlash">
                      <i class="fa fa-pencil-alt"></i>
                    </a>
                    <button onclick="deleteUser('{{ user.id }}')" class="btn btn-sm btn-alt-danger"
                            data-bs-toggle="tooltip" title="O'chirish">
                      <i class="fa fa-times"></i>
                    </button>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="10" class="text-muted text-center">Foydalanuvchilar topilmadi</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>

          <nav class="d-flex justify-content-end mt-3">
            <ul class="pagination pagination-sm mb-0">
              {% with current=users.number total=users.paginator.num_pages %}
                {% if users.has_previous %}
                  <li class="page-item">
                    <a class="page-link" href="?page=
                      {{ users.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if filter_type %}&filter_type={{ filter_type }}{% endif %}{% if group_name %}&group_name={{ group_name }}{% endif %}">«</a>
                  </li>
                {% endif %}
                {% if current > 3 %}
                  <li class="page-item"><a class="page-link"
                                           href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if filter_type %}&filter_type={{ filter_type }}{% endif %}{% if group_name %}&group_name={{ group_name }}{% endif %}">1</a>
                  </li>
                  {% if current > 4 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                  {% endif %}
                {% endif %}
                {% for num in users.paginator.page_range %}
                  {% if num >= current|add:'-2' and num <= current|add:'2' %}
                    <li class="page-item {% if num == current %}active{% endif %}">
                      <a class="page-link" href="?page=
                        {{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if filter_type %}&filter_type={{ filter_type }}{% endif %}{% if group_name %}&group_name={{ group_name }}{% endif %}">{{ num }}</a>
                    </li>
                  {% endif %}
                {% endfor %}
                {% if current < total|add:'-2' %}
                  {% if current < total|add:'-3' %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                  {% endif %}
                  <li class="page-item"><a class="page-link" href="?page=
                    {{ total }}{% if search_query %}&search={{ search_query }}{% endif %}{% if filter_type %}&filter_type={{ filter_type }}{% endif %}{% if group_name %}&group_name={{ group_name }}{% endif %}">{{ total }}</a>
                  </li>
                {% endif %}
                {% if users.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?page=
                      {{ users.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if filter_type %}&filter_type={{ filter_type }}{% endif %}{% if group_name %}&group_name={{ group_name }}{% endif %}">»</a>
                  </li>
                {% endif %}
              {% endwith %}
            </ul>
          </nav>
        </div>
      </div>

      <!-- Progress Modal -->
      <div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="importModalLabel">Ma'lumotlarni yuklash</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p id="importStatus">Yuklanmoqda...</p>
              <div class="progress">
                <div id="importProgress" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0"
                     aria-valuemin="0" aria-valuemax="100">0%
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>
{% endblock content %}

{% block script %}
  <script src="{% static 'assets/js/plugins/sweetalert2/sweetalert2.all.min.js' %}"></script>
  <script>
    // CSRF tokenini olish
    function getCsrfToken() {
      const token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
      if (!token) {
        Swal.fire({
          title: 'Xato!',
          text: 'CSRF token topilmadi',
          icon: 'error',
          confirmButtonText: 'OK',
        });
        return null;
      }
      return token;
    }

    // Umumiy import funksiyasi
    function startImport(type, title) {
      const modal = new bootstrap.Modal(document.getElementById('importModal'));
      modal.show();
      const statusElement = document.getElementById('importStatus');
      const progressElement = document.getElementById('importProgress');
      statusElement.innerText = `${title} yuklanmoqda...`;
      progressElement.style.width = '0%';
      progressElement.innerText = '0%';

      let url;
      switch (type) {
        case 'students':
          url = "{% url 'import_students' %}";
          break;
        case 'staff':
          url = "{% url 'import_staff' %}";
          break;
        case 'face_encodings':
          url = "{% url 'generate_face_encodings' %}";
          break;
        default:
          console.error('Noto‘g‘ri import turi:', type);
          return;
      }

      const source = new EventSource(url);
      source.onmessage = function(event) {
        const data = JSON.parse(event.data);
        statusElement.innerText = data.status;
        progressElement.style.width = `${data.progress}%`;
        progressElement.innerText = `${data.progress}%`;
        if (data.progress >= 100) {
          source.close();
          Swal.fire({
            title: 'Muvaffaqiyat!',
            text: data.status,
            icon: 'success',
            confirmButtonText: 'OK',
          }).then(() => {
            modal.hide();
            location.reload();
          });
        }
      };
      source.onerror = function() {
        source.close();
        statusElement.innerText = `❌ ${title} yuklashda xato!`;
        progressElement.classList.add('bg-danger');
        progressElement.style.width = '100%';
        progressElement.innerText = 'Xato';
        Swal.fire({
          title: 'Xato!',
          text: `${title} yuklashda xato yuz berdi!`,
          icon: 'error',
          confirmButtonText: 'OK',
        });
      };
    }

    // Foydalanuvchini o'chirish
    function deleteUser(userId) {
      const csrfToken = getCsrfToken();
      if (!csrfToken) return;

      Swal.fire({
        title: 'O‘chirishni tasdiqlaysizmi?',
        text: 'Foydalanuvchi butunlay o‘chiriladi',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Ha, o‘chirish!',
        cancelButtonText: 'Bekor',
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/question/delete/${userId}/`, {
            method: 'DELETE',
            headers: {
              'X-CSRFToken': csrfToken,
              'X-Requested-With': 'XMLHttpRequest',
            },
          })
            .then((response) => response.json())
            .then((data) => {
              Swal.fire({
                title: data.success ? 'Muvaffaqiyat!' : 'Xato!',
                text: data.message,
                icon: data.success ? 'success' : 'error',
                confirmButtonText: 'OK',
              }).then(() => data.success && location.reload());
            })
            .catch(() => {
              Swal.fire({
                title: 'Xato!',
                text: 'Server bilan bog‘lanishda xato',
                icon: 'error',
                confirmButtonText: 'OK',
              });
            });
        }
      });
    }

    // Guruhlar ro‘yxatini olish
    async function fetchGroups() {
      try {
        const response = await fetch('/question/api/groups/');
        if (!response.ok) throw new Error(`API xato: ${response.status}`);
        const groups = await response.json();
        const select = document.getElementById('group-select');
        select.innerHTML = '<option value="">Guruhni tanlang</option>';
        groups.forEach(group => {
          const option = document.createElement('option');
          option.value = group.group_name;
          option.textContent = group.group_name;
          select.appendChild(option);
        });
      } catch (error) {
        const alert = document.getElementById('error-alert');
        alert.textContent = `Guruhlarni yuklashda xato: ${error.message}`;
        alert.classList.remove('d-none');
      }
    }

    // Guruh tanlash oynasini ko‘rsatish
    function showGroupImport() {
      document.getElementById('group-import-container').style.display = 'block';
      fetchGroups();
    }

    // Guruh bo‘yicha import qilish
    function startGroupImport() {
      const groupId = document.getElementById('group-select').value;
      if (!groupId) {
        const alert = document.getElementById('error-alert');
        alert.textContent = 'Iltimos, guruhni tanlang!';
        alert.classList.remove('d-none');
        return;
      }
      startImport(`students-by-group?group_id=${encodeURIComponent(groupId)}`, 'Guruh bo‘yicha talabalar');
    }

    // auth_is_id toggle
    document.querySelectorAll('.auth-toggle').forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const userId = this.dataset.userId;
        const authIsId = this.checked;
        fetch(`/question/users/toggle-auth/${userId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: JSON.stringify({ auth_is_id: authIsId }),
        })
          .then(res => res.json())
          .then(data => {
            Swal.fire({
              title: data.success ? 'Muvaffaqiyat!' : 'Xato!',
              text: data.message,
              icon: data.success ? 'success' : 'error',
              confirmButtonText: 'OK',
            });
          })
          .catch(() => {
            Swal.fire({
              title: 'Xato!',
              text: 'Server bilan bog‘lanishda xato',
              icon: 'error',
              confirmButtonText: 'OK',
            });
          });
      });
    });
  </script>
{% endblock script %}