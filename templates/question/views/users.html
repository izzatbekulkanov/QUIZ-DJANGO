{% extends 'question/main.html' %}
{% load static %}
{% block style %}

{% endblock style %}

{% block content %}
    <main id="main-container">
        <!-- Page Content -->
        <div class="content">
          <!-- Quick Overview -->
          <div class="row">
            <div class="col-6 col-lg-3">
              <a class="block block-rounded block-link-shadow text-center" href="javascript:void(0)">
                <div class="block-content block-content-full">
                  <div class="fs-2 fw-semibold text-dark">{{ today_users_count }}</div>
                </div>
                <div class="block-content py-2 bg-body-light">
                  <p class="fw-medium fs-sm text-muted mb-0">
                    Bugun qo'shilgan
                  </p>
                </div>
              </a>
            </div>
            <div class="col-6 col-lg-3">
              <a class="block block-rounded block-link-shadow text-center" href="javascript:void(0)">
                <div class="block-content block-content-full">
                  <div class="fs-2 fw-semibold text-dark">{{ yesterday_users_count }}</div>
                </div>
                <div class="block-content py-2 bg-body-light">
                  <p class="fw-medium fs-sm text-muted mb-0">
                    Kecha qo'shilgan
                  </p>
                </div>
              </a>
            </div>
            <div class="col-6 col-lg-3">
              <a class="block block-rounded block-link-shadow text-center" href="javascript:void(0)">
                <div class="block-content block-content-full">
                  <div class="fs-2 fw-semibold text-dark">{{ month_users_count }}</div>
                </div>
                <div class="block-content py-2 bg-body-light">
                  <p class="fw-medium fs-sm text-muted mb-0">
                    Ushbu oyda qo'shilgan
                  </p>
                </div>
              </a>
            </div>
          </div>
          <!-- END Quick Overview -->

          <!-- All Users -->
          <div class="block block-rounded">
            <div class="block-header block-header-default">
              <h3 class="block-title">Foydalanuvchilar</h3>
              <div class="block-options">
                <a type="button" class="btn btn-info" href="{% url 'add-user' %}">
                  Foydalanuvchi qo'shish <i class="fa fa-add ms-1"></i>
                </a>
              </div>
            </div>
            <div class="block-content">
              <!-- Search Form -->
              <form method="GET" action="" class="mb-4">
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control form-control-alt"
                    id="search"
                    name="search"
                    value="{{ search_query }}"
                    placeholder="Foydalanuvchini qidiring.."
                  >
                  <span class="input-group-text bg-body border-0">
                    <i class="fa fa-search"></i>
                  </span>
                </div>
              </form>
              <!-- END Search Form -->

              <!-- Users Table -->
              <div class="table-responsive">
                <table class="table table-bordered table-hover table-sm table-striped table-vcenter">
                  <thead>
                    <tr>
                      <th class="text-center" style="width: 80px;">#</th>
                      <th>Ismi</th>
                      <th>Familiyasi</th>
                      <th class="d-none d-sm-table-cell">Telefon</th>
                      <th class="d-none d-sm-table-cell">Manzil</th>
                      <th class="d-none d-sm-table-cell">Tug'ilgan sana</th>
                      <th>Rasm</th>
                      <th class="text-center">Harakat</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for user in users %}
                    <tr>
                      <td class="text-center fs-sm">{{ forloop.counter }}</td>
                      <td class="fs-sm">{{ user.first_name }}</td>
                      <td class="fs-sm">{{ user.second_name }}</td>
                      <td class="d-none d-sm-table-cell fs-sm">{{ user.phone_number }}</td>
                      <td class="d-none d-sm-table-cell fs-sm">{{ user.address }}</td>
                      <td class="d-none d-sm-table-cell fs-sm">{{ user.date_of_birth }}</td>
                      <td class="text-center">
                        <img
                          src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}{% static 'assets/media/avatars/default-avatar.jpg' %}{% endif %}"
                          alt="Profil rasmi"
                          class="img-thumbnail"
                          style="
                            border-radius: 50%;
                            object-fit: cover;
                            width: 50px;
                            height: 50px;"
                        >
                      </td>
                      <td class="text-center">
                        <a class="btn btn-sm btn-alt-secondary" href="{% url 'edit-user' user.id %}" data-bs-toggle="tooltip" title="Tahrirlash">
                          <i class="fa fa-fw fa-pencil-alt"></i>
                        </a>
                        <a class="btn btn-sm btn-alt-secondary" href="javascript:void(0)" data-bs-toggle="tooltip" title="O'chirish" onclick="deleteUser('{{ user.id }}')">
                          <i class="fa fa-fw fa-times"></i>
                        </a>
                      </td>
                    </tr>
                    {% empty %}
                    <tr>
                      <td colspan="8" class="text-center text-muted">Foydalanuvchilar topilmadi</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <!-- END Users Table -->
          <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
              <!-- Pagination -->
              <nav aria-label="Users Pagination">
                <ul class="pagination pagination-sm justify-content-end mt-2">
                  {% for page_num in users.paginator.page_range %}
                  <li class="page-item {% if users.number == page_num %}active{% endif %}">
                    <a class="page-link" href="?page={{ page_num }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ page_num }}</a>
                  </li>
                  {% endfor %}
                </ul>
              </nav>
              <!-- END Pagination -->
            </div>
          </div>
          <!-- END All Users -->
        </div>
        <!-- END Page Content -->
      </main>
{% endblock content %}

{% block script %}
    <script src="{% static 'assets/js/plugins/sweetalert2/sweetalert2.all.min.js' %}"></script>

 <script>
  function deleteUser(userId) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    if (!csrfToken) {
      console.error("CSRF token topilmadi!");
      Swal.fire({
        title: 'Xatolik!',
        text: 'CSRF token topilmadi!',
        icon: 'error',
        confirmButtonText: 'OK',
      });
      return;
    }

    Swal.fire({
      title: 'Tasdiqlaysizmi?',
      text: "Ushbu foydalanuvchini o'chirmoqchimisiz?",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Ha, o\'chirish!',
      cancelButtonText: 'Bekor qilish',
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/question/delete/${userId}/`, {
          method: 'DELETE',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              Swal.fire({
                title: 'Muvaffaqiyatli!',
                text: data.message,
                icon: 'success',
                confirmButtonText: 'OK',
              }).then(() => {
                window.location.reload(); // Sahifani qayta yuklash
              });
            } else {
              Swal.fire({
                title: 'Xatolik!',
                text: data.message || 'Foydalanuvchini o\'chirishda xatolik yuz berdi!',
                icon: 'error',
                confirmButtonText: 'OK',
              });
            }
          })
          .catch((error) => {
            Swal.fire({
              title: 'Xatolik!',
              text: 'Server bilan bog\'lanishda xatolik yuz berdi!',
              icon: 'error',
              confirmButtonText: 'OK',
            });
            console.error('Xatolik:', error);
          });
      }
    });
  }
</script>
{% endblock script %}

